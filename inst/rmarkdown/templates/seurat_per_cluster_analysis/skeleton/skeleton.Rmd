---
title: "Per Cluster Analysis"
author: "`r getOption('author')`"
date: "`r Sys.Date()`"
bibliography: bibliography.bib
params:
    seuratFile: "data/seurat.rda"
---

```{r setup, cache=FALSE, message=FALSE, warning=FALSE}
# Last modified 2018-01-24
suppressPackageStartupMessages(library(bcbioSingleCell))

# Shared R Markdown settings
prepareSingleCellTemplate()
if (file.exists("setup.R")) {
    source("setup.R")
}

# Load seurat object
seuratName <- load(params$seuratFile)
seurat <- get(seuratName, inherits = FALSE)

interestingGroups <- interestingGroups(seurat)
```

```{r header, child="_header.Rmd", eval=file.exists("_header.Rmd")}
```



```{r sample_metadata}
sampleMetadata(seurat)
```



# tSNE (all clusters) {.tabset}

```{r plot_tsne_all_clusters, results="asis"}
groups <- unique(c("ident", "sampleName", interestingGroups))
lapply(seq_along(groups), function(a) {
    mdHeader(groups[[a]], level = 2, asis = TRUE)
    plotTSNE(seurat, interestingGroups = groups[[a]]) %>%
        show()
}) %>%
    invisible()
rm(groups)
```



# tSNE per cluster {.tabset}

```{r}
ident <- levels(seurat@ident)
groups <- unique(c("sampleName", interestingGroups))
```


```{r plot_tsne_per_cluster, results="asis"}
lapply(seq_along(ident), function(a) {
    subset <- SubsetData(seurat, ident.use = ident[[a]])
    mdHeader(ident[[a]], level = 2, asis = TRUE, tabset = TRUE)
    lapply(seq_along(groups), function(a) {
        mdHeader(groups[[a]], level = 3, asis = TRUE)
        plotTSNE(subset, interestingGroups = groups[[a]]) %>%
            show()
    }) %>%
        invisible()
}) %>%
    invisible()
```



# Cell counts per cluster {.tabset}

```{r cell_counts_per_cluster, results="asis"}
lapply(seq_along(ident), function(a) {
    subset <- SubsetData(seurat, ident.use = ident[[a]])
    mdHeader(ident[[a]], level = 2, asis = TRUE, tabset = TRUE)
    master <- subset@meta.data %>%
        as.data.frame() %>%
        uniteInterestingGroups(interestingGroups) %>%
        dplyr::select(sampleName, interestingGroups)
    sampleStats <- master %>%
        arrange(sampleName) %>%
        group_by(sampleName) %>%
        summarize(count = n()) %>%
        mutate(pct = count / sum(count))
    intgroupStats <- master %>%
        arrange(interestingGroups) %>%
        group_by(interestingGroups) %>%
        summarize(count = n()) %>%
        mutate(pct = count / sum(count))
    kable(sampleStats, digits = 2L) %>%
        show()
    kable(intgroupStats, digits = 2L) %>%
        show()
}) %>%
    invisible()
```



# Seurat parameters {.tabset}

```{r seurat_diagnostics}
mdHeader("PrintPCAParams", level = 2)
PrintPCAParams(seurat)

mdHeader("PrintFindClustersParams", level = 2)
PrintFindClustersParams(seurat)

mdHeader("PrintTSNEParams", level = 2)
PrintTSNEParams(seurat)

mdHeader("PrintSNNParams", level = 2)
PrintSNNParams(seurat)
```



```{r footer, child="_footer.Rmd", eval=file.exists("_footer.Rmd")}
```
